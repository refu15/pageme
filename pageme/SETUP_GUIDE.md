# 本番環境接続設定ガイド (SETUP_GUIDE)

このアプリを実際の Supabase / n8n / Typebot に接続するための詳細手順です。

## 1. Supabase (データベース & 認証) の設定

### 手順 1-1: プロジェクト作成とAPIキーの取得
1.  [Supabase](https://supabase.com/) にログインし、"New Project" を作成します。
2.  プロジェクトが作成されたら、サイドバーの **Settings (歯車アイコン) > API** に移動します。
3.  以下の2つの値をコピーし、メモしておきます。
    -   **Project URL**
    -   **anon public** key

### 手順 1-2: データベースの作成 (SQL実行)
1.  サイドバーの **SQL Editor** を開きます。
2.  "New Query" をクリックし、同梱の `supabase_schema.sql` の内容をすべて貼り付けます。
3.  "Run" ボタンを押して実行します。これで `profiles` テーブルが作成されます。

### 手順 1-3: 画像保存用バケットの作成
1.  サイドバーの **Storage** を開きます。
2.  "New Bucket" をクリックします。
    -   Name: `avatars` (または `images`)
    -   Public bucket: **ON** (重要)
3.  作成後、バケットの設定から "Policies" を確認し、画像アップロード/参照が許可されているか確認します（開発時はPublicでOK）。

---

## 2. 環境変数の設定 (Next.js)

プロジェクトのルートディレクトリ（`c:\Users\nnkre\pageme`）に `.env.local` という名前の新しいファイルを作成し、以下の内容を記述してください。

```env
# 手順1-1で取得した値を貼り付けてください
NEXT_PUBLIC_SUPABASE_URL=書き換えてください
NEXT_PUBLIC_SUPABASE_ANON_KEY=書き換えてください

# アプリのURL (ローカル開発用)
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

---

## 3. Typebot (チャットボット) の設定

### 手順 3-1: Typebotの作成 (AIインタビュアー・ループ設定)

### 手順 3: Typebotの作成 (手動設定・確実版)
インポートエラーを回避するため、以下の手順で手動作成を行います。**所要時間は約5分**です。

**1. 新規作成**
1.  Typebotダッシュボードで **Create a typebot** > **Start from scratch** を選択。
2.  名前を `AI Resume Interviewer` に変更。

**2. 変数の作成 (Variables)**
画面上の **(x) Variables** タブを開き、以下の3つの変数を追加します。
- `user_input`
- `ai_response`
- `chat_history`

**3. フローの構築**
**Flow** タブに戻り、以下の通りにブロックを配置・接続します。

#### Group 1: 初期化 (Start直下)
1.  **Start** ブロックの下に **Set variable** ブロックを追加。
    -   Variable: `user_input`
    -   Value: `面接開始`
2.  その下に **Set variable** ブロックを追加。
    -   Variable: `chat_history`
    -   Value: `(半角スペース1つ)`  **※重要：ここを空欄にするとループエラーの原因になります！必ずスペースを入れてください**

#### Group 2: AI脳 (OpenAI)
新しいグループを作成し、**OpenAI** > **Create chat completion** ブロックを置きます。
-   **Credentials**: ご自身のOpenAIアカウントを選択
-   **Model**: `gpt-4o`  **(※ gpt-5などを手入力せず、必ず gpt-4o または gpt-4o-mini を選択してください)**
-   **Messages**:
    -   **Message 1** (Role: **System**): 下記のプロンプトをコピペしてください。
    -   **Message 2** (Role: **User**): Valueに変数 `{{user_input}}` を選択。
-   **Response mapping**: 変数 `ai_response` を選択

> **システムプロンプト (コピペ用):**
> **※以下の枠内のテキストを「すべてまとめて」コピーし、OpenAIブロックの System (Message 1) に貼り付けてください。**
> (これ1つで、挨拶・面接・終了判定のすべてを行います)
```text
あなたは優秀なキャリアコーチAIです。
以下はこれまでの会話履歴です：
---
{{chat_history}}
---

この履歴を踏まえて、ユーザーの次の発言（User Input）に対して応答してください。

【状況判断】
もしユーザーの発言が「面接開始」のみで、会話履歴がまだ空（または挨拶をしていない）場合は、以下の挨拶を出力して始めてください：
「こんにちは！AIキャリアコーチです。
ここからは、あなたの経歴だけでなく、あなたが『無理なく輝ける場所（Infinite Fuel）』や『避けるべき環境（Energy Drain）』を見つけるためのインタビューを行います。
リラックスして、思ったことをそのまま話してくださいね。
まずは、お名前と現在の所属を教えていただけますか？」

【面接ルール】
1. 質問は必ず**1回につき1つ**だけにする（会話のキャッチボールを重視）。
2. 履歴情報に基づき、ユーザーの回答が抽象的なら「深掘り質問」をする（例：「具体的にどんなエピソードがありますか？」）。
3. 以下の必須項目を全て回収するまで会話を続ける。

【必須回収項目リスト】
1. 基本情報（名前・所属）
2. 役割詳細
3. スキル・資格
4. プロジェクト名
5. 成果 (数字で)
6. 困難
7. 工夫・行動 (Action)
8. 学び・強み
9. 無限にできること (Infinite Fuel / いくらやっても疲れないこと)
10. やる気が削がれること (Energy Drain / 苦手な環境)
11. 起動コマンド (自分をうまく扱うためのコツ)

【終了条件】
全項目を聞き出し終えたら、最後に感謝を述べた上で、必ず `[COMPLETED]` と出力してください。
```

3.  OpenAIブロックの下に **Condition** ブロックを追加。
    -   Compare: `ai_response`
    -   Operator: **Contains**
    -   Value: `[COMPLETED]`
    -   ※これに該当したら「終了グループ」へ繋ぎます。

#### Group 3: チャットUI
新しいグループを作成します。
1.  **Text** ブロックを追加。
    -   Content: `{{ai_response}}`
2.  **Text Input** ブロックを追加。
    -   Variable: `user_input`
    -   Settings > **Long text**: ON (推奨)

#### Group 4: 記憶の更新 (History Update)
新しいグループを作成します。
1.  **Set variable** ブロックを追加。
    -   Variable: `chat_history`
    -   **Change Type**: ドロップダウン（最初は Custom や Text になっている箇所）から **Append value(s)** を選択してください。
    -   Value:
        ```text

        User: {{user_input}}
        AI: {{ai_response}}
        ```
    -   **重要:** `{{chat_history}}` は**書かないでください**（Appendモードなので自動で追加されます）。
    -   **重要:** 先頭に必ず「改行（エンターキー）」を1回入れてください。そうしないと前の会話と繋がってしまいます。

#### Group 5: 終了 (End)
新しいグループを作成します。
1.  **Text** ブロックを追加。
    -   Content: `インタビュー終了です！履歴書を生成します。`

**4. 矢印による接続 (ループ作成)**
1.  **Group 1 (初期化)** -> **Group 2 (AI脳)**
2.  **Group 2 (AI脳)** の OpenAIブロック -> **Group 3 (チャットUI)**
3.  **Group 2 (AI脳)** の Condition (COMPLETED) -> **Group 5 (終了)**
4.  **Group 3 (チャットUI)** -> **Group 4 (記憶更新)**
5.  **Group 4 (記憶更新)** -> **Group 2 (AI脳)**  **(これでループが完成！)**

**5. 完成！**
右上の **Publish** を押し、**Share** タブからURLを取得するか、埋め込み設定を行ってください。

---

### システムプロンプト (履歴埋め込み版)

以下のプロンプトをOpenAIブロックのSystemに貼り付けてください。
**※ `{{chat_history}}` の部分は、Typebot上で変数が青色になるように正しく挿入してください。**

```text
あなたは優秀なキャリアコーチAIです。
以下はこれまでの会話履歴です：
---
{{chat_history}}
---

この履歴を踏まえて、ユーザーの次の発言（User Input）に対して応答してください。

【面接ルール】
1. 質問は必ず**1回につき1つ**だけにする。
2. 履歴情報に基づき、ユーザーの回答が抽象的なら「深掘り質問」をする。
3. 以下の必須項目を全て回収するまで会話を続ける。

【必須回収項目】
1. 基本情報（名前・所属）
2. 役割詳細
3. スキル・資格
4. プロジェクト名
5. 成果 (数字で)
6. 困難
7. 工夫・行動 (Action)
8. 学び・強み
9. 無限にできること (Infinite Fuel)
10. やる気が削がれること (Energy Drain)
11. 起動コマンド

【終了条件】
全項目を聞き出し終えたら、最後に `[COMPLETED]` と出力してください。
```

---

### システムプロンプト (挨拶文入り)

以下のプロンプトをOpenAIブロックのSystemに貼り付けてください。

```text
あなたは優秀なキャリアコーチAIです。
ユーザーとの対話を通じて、履歴書と「取扱説明書（トリセツ）」を作成するための情報を引き出します。

【最初の挨拶】
ユーザーから「面接開始」という合図が来たら、以下の挨拶で始めてください：
「こんにちは！AIキャリアコーチです。
ここからは、あなたの経歴だけでなく、あなたが『無理なく輝ける場所（Infinite Fuel）』や『避けるべき環境（Energy Drain）』を見つけるためのインタビューを行います。
リラックスして、思ったことをそのまま話してくださいね。
まずは、お名前と現在の所属を教えていただけますか？」

【面接ルール】
1. 質問は必ず**1回につき1つ**だけにする（あえて短く、会話のキャッチボールをする）。
2. ユーザーの回答が短い場合は「それは具体的にどういうことですか？」「例えばどんなエピソードがありますか？」と深掘りする。
3. 以下の必須項目を全て回収するまで会話を続ける。

【必須回収項目】
1. 基本情報（名前・所属）
2. 役割詳細
3. プロジェクト成果 (数字で)
4. 直面した困難
5. 乗り越えた工夫・行動 (Action)
6. 学び・強み
7. 無限にできること (Infinite Fuel)
8. やる気が削がれること (Energy Drain)
9. 起動コマンド (連携のコツ)

【終了条件】
全項目を聞き出し終えたら、最後に「ありがとうございます！素晴らしい履歴書ができそうです。」と言った後、必ず `[COMPLETED]` という文字列を出力してください。
```

```text
あなたは優秀なキャリアコーチAIです。
ユーザーとの対話を通じて、以下の「履歴書作成に必要な11の情報」を全て引き出してください。
一度に全ての質問をせず、**1つずつ**順番に聞いてください。
ユーザーの回答が抽象的だったり浅い場合は、**必ず「深掘り質問」を行って**、具体的なエピソードや数字を引き出してください。

【必須回収項目リスト】
1. 基本情報（名前・現在の所属）
2. 所属の詳細（部署・役職・学年等）
3. スキル・資格・リンク
4. アピールしたいプロジェクト名（タイトル）
5. その活動での具体的な「成果」(数字を含めるよう促す)
6. 直面した「困難・壁」
7. その壁を乗り越えた「工夫・行動」(Action) ※最重要。詳細に聞く。
8. 経験からの「学び」と、自覚している「強み」
9. 無限に湧くやる気の源泉 (Infinite Fuel / いくらやっても疲れないこと)
10. やる気を削ぐ要因 (Energy Drain / 苦手な環境)
11. 自分をうまく扱うための「起動コマンド」(連携のコツ)

【ルール】
- 口調は親しみやすく、かつプロフェッショナルに。
- 1回の発言で質問は1つまで。
- 全ての項目を聞き出し終えたら、最後に必ず「[COMPLETED]」という文字列を含めて終了の挨拶をしてください。
```

4.  **終了条件の設定 (Logic)**
    -   ループの中に **Condition (条件分岐)** を挟みます。
    -   もし `ai_response` が `[COMPLETED]` を含む場合 → ループを抜けて **End** へ。

### 手順 3-2: 埋め込みIDの取得と適用
1.  Typebotの "Share" タブを開きます。
2.  "Standard" などの埋め込みコード内にある、`typebot="my-typebot"` のようなID部分を探します。
3.  `app/onboarding/page.tsx` ファイルを開き、以下の部分を書き換えます。

```tsx
// app/onboarding/page.tsx 68行目あたり
<Standard
  typebot="あなたのTypebotのPublic IDをここに記入" 
  style={{ width: "100%", height: "100%" }}
  onEnd={handleEnd}
/>
```

---

## 4. データ処理の設定（2つの方法）

### 方法A: Next.js 直接統合（推奨・簡単）

TypebotのWebhookブロックが使えない場合、こちらの方法を使います。
Next.jsフロントエンドが直接OpenAIとSupabaseに接続します。

**必要な環境変数を `.env.local` に追加:**
```env
# 既存の設定に加えて、以下を追加
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxx
SUPABASE_SERVICE_ROLE_KEY=eyJxxxxxxxxxxxxxxxxxxxx
```

**取得方法:**
- **OPENAI_API_KEY**: [OpenAI API Keys](https://platform.openai.com/api-keys) から発行
- **SUPABASE_SERVICE_ROLE_KEY**: Supabase > Settings > API > service_role (secret)

**フロー:**
```
Typebot終了 → Next.js onEnd → /api/process-resume → OpenAI抽出 → Supabase保存
```

**設定完了後、サーバーを再起動:**
```bash
# Ctrl+C で停止後
npm run dev
```

---

### 方法B: n8n ワークフロー（上級者向け）

TypebotのWebhookブロックが使える場合はこちらを使用できます。
